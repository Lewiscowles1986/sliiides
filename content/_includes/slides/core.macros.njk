{% import "slides.macros.njk" as slides %}
{% import "embed.macros.njk" as embed %}
{% import "utility.macros.njk" as utility %}

{% macro demo(slide, page, collections) %}
  {% set demoPage = collections.all | findPage('data.demo', slide.demo) %}
  {%- set pres %}[[permalink]({{ demoPage.url }})]{% endset -%}
  {%- set caption = [slide.caption or demoPage.data.title, pres] | join(' ') -%}
  {%- set slide = slide | merge({'caption': caption}) -%}
  {% call slides.base(slide, 'demo', page) %}
    {{ embed.iframe(
      src=demoPage.url,
      width=slide.width or 560,
      height=slide.height or 315
    ) }}
  {% endcall %}
{% endmacro %}

{% macro title(slide, page) %}
  {% call slides.base(slide, 'title', page) %}
    {{ slides.title(slide) }}
  {% endcall %}
{% endmacro %}

{% macro img(slide, page) %}
  {% set imgStyle = {
    '--img-position': slide.position,
    '--img-fit': slide.fit
  } %}
  {% set styles = slide.style | merge(imgStyle) %}
  {% call slides.base(slide, 'img', page, styles) %}
    {{ embed.img(
      src=slide.img,
      alt=slide.alt
    ) }}
  {% endcall %}
{% endmacro %}

{% macro quote(slide, page) %}
  {% call slides.base(slide, 'quote', page) %}
    <blockquote>
      {{ slide.quote | md | safe }}
      <div class="cite h-card">
        {{- '--' | mdInline | safe -}}
        {{- slide.cite | mdInline | safe -}}
      </div>
    </blockquote>
  {% endcall %}
{% endmacro %}

{% macro md(slide, page) %}
  {% call slides.base(slide, 'markdown', page) %}
    {{ slides.title(slide) }}
    <div class="md">
      {{ slide.md | md | safe }}
    </div>
  {% endcall %}
{% endmacro %}

{% macro pen(slide, page) %}
  {%- set pres %}[[present](https://codepen.io/{{ slide.user or 'mirisuzanne' }}/pres/{{ slide.id }}?editors=1100)]{% endset -%}
  {%- set caption = [slide.caption, pres] | join(' ') if slide.caption else pres -%}
  {%- set slide = slide | merge({'caption': caption}) -%}
  {% call slides.base(slide, 'codepen', page) %}
    {{ embed.codepen(
      id=slide.id,
      title=slide.pen,
      edit=false if slide.noedit else true,
      height=slide.height or 500,
      theme=slide.theme or '39098',
      tab=slide.tab or 'result',
      preview=slide.preview
    ) }}
  {% endcall %}
{% endmacro %}

{% macro list(slide, page) %}
  {%- set content -%}
  {%- for item in (slide.ol or slide.ul) -%}
    {% set feature =
      (loop.index in slide.feature)
      if slide.feature | typeCheck('array')
      else (loop.index == slide.feature)
    %}
    <li {% if feature %}class="feature"{% endif %}>
      {{- item | mdInline | safe -}}
    </li>
  {%- endfor -%}
  {%- endset -%}
  {% call slides.base(slide, 'list', page) %}
    {{ slides.title(slide) }}
    {% if slide.ol %}
      <ol>{{ content | safe }}</ol>
    {% else %}
      <ul>{{ content | safe }}</ul>
    {% endif %}
  {% endcall %}
{% endmacro %}

{% macro default(slide, page) %}
  {% call slides.base(slide, 'default', page) %}
<pre>
{%- for key, val in slide -%}
{%- if not (key in ['page', 'index']) %}
{{ key }}: {{ val }}
{%- endif -%}
{%- endfor -%}
</pre>
  {% endcall %}
{% endmacro %}

{% macro find(slide, page, collections) %}
  {% if slide.demo %}
    {{ demo(slide, page, collections) }}
  {% elif slide.img %}
    {{ img(slide, page) }}
  {% elif slide.quote %}
    {{ quote(slide, page) }}
  {% elif slide.pen %}
    {{ pen(slide, page) }}
  {% elif slide.md %}
    {{ md(slide, page) }}
  {% elif slide.ol or slide.ul %}
    {{ list(slide, page) }}
  {% elif slide.title %}
    {{ title(slide, page) }}
  {% else %}
    {{ default(slide, page) }}
  {% endif %}
{% endmacro %}
