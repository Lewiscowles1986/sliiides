{% import "slides.macros.njk" as slides %}
{% import "embed.macros.njk" as embed %}
{% import "utility.macros.njk" as utility %}

{% macro demo(slide, page, collections) %}
  {%- set demoUrl = slide.demo if ('://' in slide.demo) else none -%}
  {%- set demoPage = false if demoUrl else collections.all | findPage('data.demo', slide.demo) -%}
  {%- set demoUrl = demoPage.url if demoPage else demoUrl -%}
  {%- set demoTitle = demoPage.data.title if demoPage else slide.title -%}
  {%- set pres %}[[permalink]({{ demoUrl }})]{% endset -%}
  {%- set caption = [slide.caption or demoTitle, pres] | join(' ') -%}
  {%- set slide = slide | merge({'caption': caption}) -%}
  {% call slides.base(slide, 'demo', page) %}
    {{ embed.iframe(
      src=demoUrl,
      width=slide.width or 560,
      height=slide.height or 315
    ) }}
  {% endcall %}
{% endmacro %}

{% macro title(slide, page) %}
  {% call slides.base(slide, 'title', page) %}
    {{ slides.title(slide) }}
  {% endcall %}
{% endmacro %}

{% macro img(slide, page) %}
  {% set imgStyle = {
    '--img-position': slide.position,
    '--img-fit': slide.fit
  } %}
  {% set styles = slide.style | merge(imgStyle) %}
  {% call slides.base(slide, 'img', page, styles) %}
    {{ embed.img(
      src=slide.img,
      alt=slide.alt
    ) }}
  {% endcall %}
{% endmacro %}

{% macro person(slide, page) %}
  {% set imgStyle = {
    '--img-position': slide.position,
    '--img-fit': slide.fit
  } %}
  {% set styles = slide.style | merge(imgStyle) %}
  {% call slides.base(slide, 'person', page, styles, class='h-card') %}
    {{ embed.img(
      src='_people/' + slide.face,
      alt=slide.alt,
      attrs={'class': 'u-photo'}
    ) }}
    <div class="person">
      {{ slides.title(slide, 'p-name') }}
      {% if slide.md %}
      <div class="md">
        {{ slide.md | md | safe }}
      </div>
      {% endif %}
    </div>
  {% endcall %}
{% endmacro %}

{% macro quote(slide, page) %}
  {% call slides.base(slide, 'quote', page) %}
    {{ embed.blockquote(slide.quote, slide.cite) }}
  {% endcall %}
{% endmacro %}

{% macro md(slide, page) %}
  {% call slides.base(slide, 'markdown', page) %}
    {{ slides.title(slide) }}
    <div class="md">
      {{ slide.md | md | safe }}
    </div>
  {% endcall %}
{% endmacro %}

{% macro pen(slide, page) %}
  {%- set pres %}[present](https://codepen.io/{{ slide.user or 'mirisuzanne' }}/pres/{{ slide.id }}?editors=1100){% endset -%}
  {%- set raw %}[debug](https://codepen.io/{{ slide.user or 'mirisuzanne' }}/debug/{{ slide.id }}){% endset -%}
  {%- set links -%}[{{ [pres, raw] | join(' | ') }}]{%- endset -%}
  {%- set caption = [slide.caption, links] | join(' ') if slide.caption else links -%}
  {%- set slide = slide | merge({'caption': caption}) -%}
  {% call slides.base(slide, 'codepen', page) %}
    {{ embed.codepen(
      id=slide.id,
      title=slide.pen,
      edit=false if slide.noedit else true,
      height=slide.height or 500,
      theme=slide.theme or '39098',
      tab=slide.tab or 'result',
      preview=slide.preview
    ) }}
  {% endcall %}
{% endmacro %}

{% macro default(slide, page) %}
  {% call slides.base(slide, 'default', page) %}
<pre>
{%- for key, val in slide -%}
{%- if not (key in ['page', 'index']) %}
{{ key }}: {{ val }}
{%- endif -%}
{%- endfor -%}
</pre>
  {% endcall %}
{% endmacro %}

{% macro find(slide, page, collections) %}
  {% if slide.demo %}
    {{ demo(slide, page, collections) }}
  {% elif slide.face  %}
    {{ person(slide, page) }}
  {% elif slide.img %}
    {{ img(slide, page) }}
  {% elif slide.quote %}
    {{ quote(slide, page) }}
  {% elif slide.pen %}
    {{ pen(slide, page) }}
  {% elif slide.md %}
    {{ md(slide, page) }}
  {% elif slide.title %}
    {{ title(slide, page) }}
  {% else %}
    {{ default(slide, page) }}
  {% endif %}
{% endmacro %}
